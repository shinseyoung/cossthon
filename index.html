<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Mental Shield - Real-time Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기존 스타일 유지 */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; color: #334155; overscroll-behavior-y: none; }
        .glass-card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.9); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); }
        .heart-beat { animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } }
        .hidden-view { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { background-color: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        #sensitivity-input { color: #f97316; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="hidden lg:flex w-72 bg-white border-r border-slate-200 flex-col z-20 shadow-sm">
        <div class="p-8 pb-4 flex justify-start">
            <div onclick="location.reload()" class="flex items-center gap-3 text-indigo-500 mb-2 cursor-pointer">
                <i class="fa-solid fa-shield-heart text-2xl"></i>
                <span class="text-xl font-bold tracking-wide text-slate-800">My<span class="text-indigo-500">Shield</span></span>
            </div>
        </div>
        <nav class="flex-1 px-6 space-y-3 mt-6">
            <button class="nav-item active w-full flex items-center justify-start gap-4 p-4 rounded-2xl text-left font-medium"><i class="fa-solid fa-chart-line"></i>통합 모니터링</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-50">
        <header class="h-16 lg:h-20 flex items-center justify-between px-4 lg:px-10 z-10 relative border-b border-slate-200">
            <h2 class="text-lg font-bold text-slate-800">실시간 생체 데이터 분석</h2>
            <div id="connection-status" class="flex items-center gap-2 text-xs font-bold text-green-500 bg-green-50 px-3 py-1 rounded-full">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> LIVE DATA CONNECTED
            </div>
        </header>

        <div id="content-container" class="flex-1 overflow-y-auto p-4 lg:p-8 z-10 pb-24">
            <div id="view-home" class="grid grid-cols-1 lg:grid-cols-12 gap-6 fade-in">
                
                <div class="lg:col-span-8 glass-card p-6 lg:p-8 flex flex-col min-h-[480px] relative">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">실시간 뉴로-카디악 파형</h3>
                            <p class="text-sm text-slate-500">FP1 Mean (EEG) & PPG Signal Sync</p>
                        </div>
                    </div>

                    <div class="absolute top-24 right-8 z-20 flex flex-col gap-3">
                        <div class="bg-white/90 p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3">
                            <div class="text-red-500 heart-beat"><i class="fa-solid fa-heart"></i></div>
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">BPM</p>
                                <p id="live-bpm" class="text-xl font-bold text-slate-800">--</p>
                            </div>
                        </div>
                        <div class="bg-white/90 p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3">
                            <div class="text-blue-500"><i class="fa-solid fa-brain"></i></div>
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">State</p>
                                <p id="live-emotion" class="text-sm font-bold text-slate-800">Analyzing...</p>
                            </div>
                        </div>
                    </div>

                    <div class="relative flex-1 bg-slate-900 rounded-2xl overflow-hidden shadow-inner">
                        <canvas id="shieldCanvas"></canvas>
                        
                        <div class="absolute bottom-6 left-6 right-6">
                            <div id="alert-box" class="bg-white/95 backdrop-blur px-6 py-4 rounded-xl border-l-4 border-blue-400 shadow-lg flex items-start gap-4 transition-all">
                                <div id="alert-icon" class="bg-blue-100 p-2 rounded-full text-blue-500"><i class="fa-solid fa-circle-info"></i></div>
                                <div>
                                    <p id="alert-title" class="text-sm font-bold text-slate-800">데이터 수집 및 베이스라인 구축 중</p>
                                    <p id="alert-desc" class="text-xs text-slate-500 mt-1">정확한 분석을 위해 초기 생체 신호를 측정하고 있습니다. 잠시만 기다려주세요.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 glass-card p-8 flex flex-col justify-center items-center">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">현재 억눌림 부하 (Load)</h3>
                    <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Suppression Load Analysis</p>
                    
                    <div class="relative w-56 h-56 mb-6">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="50%" cy="50%" r="45%" stroke="#f1f5f9" stroke-width="12" fill="transparent" />
                            <circle id="suppressGauge" cx="50%" cy="50%" r="45%" stroke="#6366f1" stroke-width="12" fill="transparent" 
                                stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="transition-all duration-1000"/>
                        </svg>
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                            <span id="gauge-value" class="text-5xl font-bold text-slate-800 block">0</span>
                            <span class="text-xs text-slate-400 font-bold">/ 100</span>
                        </div>
                    </div>
                    <p id="state-tag" class="px-4 py-1.5 rounded-full bg-slate-100 text-slate-500 text-xs font-bold shadow-sm">WAITING</p>
                </div>

            </div>
        </div>
    </main>

    <script>
        let timeline = [];
        let currentIndex = 0;
        const canvas = document.getElementById('shieldCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // 데이터 큐 (그래프 파형 저장용)
        let eegQueue = new Array(100).fill(0);
        let ppgQueue = new Array(100).fill(0);

        // JSON 데이터 불러오기
        async function loadData() {
            try {
                const response = await fetch('analysis_result.json');
                const data = await response.json();
                timeline = data.timeline;
                console.log("Data loaded, total steps:", timeline.length);
                startAnalysis();
            } catch (error) {
                console.error("데이터를 불러오지 못했습니다. 파일 이름을 확인하세요.", error);
                document.getElementById('alert-title').innerText = "데이터 로드 오류";
                document.getElementById('alert-desc').innerText = "analysis_result.json 파일을 찾을 수 없습니다.";
            }
        }

        function resize() {
            width = canvas.parentElement.clientWidth;
            height = canvas.parentElement.clientHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        function startAnalysis() {
            setInterval(() => {
                const step = timeline[currentIndex];
                
                // 1. 큐 업데이트 (새 데이터 추가)
                eegQueue.push(step.raw_signals.fp1_mean * 500); // 가독성을 위해 배율 조정
                eegQueue.shift();
                ppgQueue.push(step.raw_signals.ppg * 10000); 
                ppgQueue.shift();

                // 2. UI 텍스트 및 게이지 업데이트
                if (step.eeg_data.HR) {
                    document.getElementById('live-bpm').innerText = Math.round(step.eeg_data.HR);
                }
                if (step.russell.emotion) {
                    document.getElementById('live-emotion').innerText = step.russell.emotion;
                }
                
                // 억눌림 지수 (0~1 사이 값을 0~100으로)
                if (step.suppression.load !== null) {
                    const loadVal = Math.round(step.suppression.load * 100);
                    updateGauge(loadVal);
                    updateAlertBox(step.suppression.state, loadVal);
                }

                currentIndex = (currentIndex + 1) % timeline.length;
                draw();
            }, 100); // 0.1초마다 업데이트 (1초 데이터를 10등분하여 자연스럽게)
        }

        function updateGauge(val) {
            document.getElementById('gauge-value').innerText = val;
            const circle = document.getElementById('suppressGauge');
            const offset = 283 - (val / 100 * 283);
            circle.style.strokeDashoffset = offset;
            
            // 색상 변경
            if (val > 70) circle.style.stroke = "#ef4444";
            else if (val > 40) circle.style.stroke = "#fb923c";
            else circle.style.stroke = "#6366f1";
        }

        function updateAlertBox(state, load) {
            const box = document.getElementById('alert-box');
            const title = document.getElementById('alert-title');
            const desc = document.getElementById('alert-desc');
            const tag = document.getElementById('state-tag');

            if (!state) return;

            tag.innerText = state;
            tag.className = "px-4 py-1.5 rounded-full text-xs font-bold shadow-sm " + 
                           (state.includes('Positive') ? "bg-green-100 text-green-600" : "bg-orange-100 text-orange-600");

            if (state === "PositiveOverload") {
                title.innerText = "안정적인 정서 상태 유지 중";
                desc.innerText = "현재 뇌파와 심박수가 긍정적인 동기화 상태를 보이고 있습니다.";
                box.style.borderColor = "#10b981";
            } else if (state === "MildSuppression") {
                title.innerText = "경미한 감정 억제 신호 감지";
                desc.innerText = "심박 변이도가 낮아지며 미세한 스트레스 반응이 포착되었습니다.";
                box.style.borderColor = "#fb923c";
            }
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // 그리드 선
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for(let i=0; i<width; i+=50) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, height); ctx.stroke();
            }

            // 1. EEG 파형 (Blue)
            ctx.beginPath();
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 2;
            for(let i=0; i<eegQueue.length; i++) {
                const x = (width / (eegQueue.length - 1)) * i;
                const y = (height / 2) - eegQueue[i] - 40;
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // 2. PPG 파형 (Red)
            ctx.beginPath();
            ctx.strokeStyle = '#f87171';
            ctx.lineWidth = 2;
            for(let i=0; i<ppgQueue.length; i++) {
                const x = (width / (ppgQueue.length - 1)) * i;
                const y = (height / 2) - ppgQueue[i] + 40;
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        loadData();
    </script>
</body>
</html>
